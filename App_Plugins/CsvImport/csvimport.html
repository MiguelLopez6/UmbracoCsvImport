
<div ng-controller="CsvImportController as vm">
    <umb-box>
        <umb-box-header title="CSV Import" description="Import CSV file to Umbraco nodes."></umb-box-header>
        <umb-box-content>

            <div ng-show="vm.window.steps[0]">
                <div class="btn btn-action"
                     name="file"
                     ngf-pattern="'.csv'"
                     ngf-accept="'.csv'"
                     ngf-select="vm.upload($file)">Upload</div>
            </div>

            <div ng-show="vm.window.steps[1]">
                <span>Select Parent Node:</span><br />
                <umb-button type="button"
                            label="Browse"
                            button-style="action"
                            action="vm.selectParentNode();">
                </umb-button>
            </div>

            <div ng-show="vm.window.steps[2]">
                <div ng-if="vm.contentTypes.length">
                    <span>Select Content Type:</span><br />
                    <select style="margin-bottom:0;"
                            ng-model="vm.selectedContentType"
                            ng-options="contentType as contentType.name for contentType in vm.contentTypes"
                            no-dirty-check>
                    </select>
                    <umb-button type="button"
                                label="Submit"
                                button-style="action"
                                action="vm.processContentType()">
                    </umb-button>
                </div>
                <p ng-if="!vm.contentTypes.length">
                    No allowed types detected for selected node.
                </p>

            </div>

            <div ng-show="vm.window.steps[3] && vm.isCsvReady">
                <ng-form name="vm.importForm" novalidate>

                    <div ng-repeat="(variantKey, variant) in vm.editableVariants">

                        <h3><strong>{{ variant.language.name }}</strong></h3>
                        <div class="flex">
                            <div class="w-25">
                                <span>Name: * </span>
                            </div>
                            <div class="w-25" style="margin-bottom:10px;">
                                <select ng-model="variant.csvHeader"
                                        ng-options="header for header in vm.csvHeaders"
                                        name="{{'name_' + variantKey}}"
                                        style="margin-bottom:2px;"
                                        no-dirty-check
                                        required>
                                </select>
                                <span ng-if="vm.importForm.$submitted && vm.importForm['name_' + variantKey].$invalid">This field is required.</span>
                            </div>
                        </div>

                        <div ng-repeat="(tabKey, tab) in variant.tabs">
                            <h4 style="margin-bottom:20px;"><strong>{{ tab.label }}</strong></h4>
                            <div ng-repeat="(propKey, prop) in tab.properties" class="flex">
                                <div class="w-25">
                                    <span>{{ prop.label }} <span ng-if="prop.validation.mandatory">*</span> </span>
                                </div>
                                <div class="w-25" style="margin-bottom:10px;">
                                    <select ng-model="prop.csvHeader"
                                            ng-options="header for header in vm.csvHeaders"
                                            ng-required="prop.validation.mandatory"
                                            name="{{ 'field_' + variantKey + '_' + tabKey + '_' + propKey  }}"
                                            style="margin-bottom:2px;"
                                            no-dirty-check>
                                    </select>

                                    <span ng-if="vm.importForm.$submitted && vm.importForm['field_' + variantKey + '_' + tabKey + '_' + propKey].$invalid">This field is required.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" ng-click="vm.submit()" ng-disabled="vm.processing" class="btn btn-action">
                        {{ vm.processing ? 'Processing ' + vm.currentItem + ' out of ' + vm.csvData.length + ' records...' : 'Submit' }}
                    </button>
                </ng-form>
                <br /><br />
                <p>This may take a while for large records.</p>
            </div>

            <div ng-show="vm.window.steps[4]">
                <h3>All done!</h3>
            </div>
        </umb-box-content>
    </umb-box>
</div>